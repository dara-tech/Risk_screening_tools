// Program Stage Data Elements - Updated with real DHIS2 data (28 elements total)
export let programStageDataElements = [
    // Sort Order 1
    {
        id: 'Q2KRbrYIKHM',
        name: '4.Have you had sex(Oral, Anal or vaginal) in the past 6months?',
        formName: 'hadSexPast6Months',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.ធ្លាប់រួមភេទក្នុងរយៈពេល៦ខែចុងក្រោយដែរឬទេ?' }]
    },
    // Sort Order 2
    {
        id: 'IjncwaiwvUv',
        name: '4.1Your partner\'s sexual identify is Male',
        formName: 'partnerMale',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.១ដៃគូរូមភេទរបស់អ្នកមានអត្តសញ្ញាណភេទជា "ប្រុស"' }]
    },
    // Sort Order 3
    {
        id: 'TlXvK6qrt1b',
        name: '4.2Your partner\'s sexual identify is Female',
        formName: 'partnerFemale',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.២ដៃគូរូមភេទរបស់អ្នកមានអត្តសញ្ញាណភេទជា "ស្រី"' }]
    },
    // Sort Order 4
    {
        id: 'G4r3E6LI70l',
        name: '4.3Your partner\'s sexual identify is TGW',
        formName: 'partnerTGW',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.៣ដៃគូរូមភេទរបស់អ្នកមានអត្តសញ្ញាណភេទជា "ស្ត្រីប្លែងភេទ"' }]
    },
    // Sort Order 5
    {
        id: 'qa4gp2GMQUA',
        name: '5.How many sexual partner do you have?',
        formName: 'numberOfSexualPartners',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៥.តើមានដៃគូរួមភេទប៉ុន្មាននាក់ក្នុងរយៈពេល៦ខែចុងក្រោយ?' }]
    },
    // Sort Order 6
    {
        id: 'd30ueni5gyM',
        name: '4.Have had the following practice in the past 6months?',
        formName: 'past6MonthsPractices',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.តើធ្លាប់មានការប្រព្រឹត្តប្រឈមទាំងនេះដែរឬទេក្នុងរយៈពេល៦ខែចុងក្រោយ?' }]
    },
    // Sort Order 7
    {
        id: 'upbKDAnhG8T',
        name: '11.Had test for HIV in past 6 months?',
        formName: 'hivTestPast6Months',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៥.តើធ្លាប់ធ្វើតេស្តមេរោគអេដស៍ដែរឬទេក្នុងរយៈពេល៦ខែចុងក្រោយ?' }]
    },
    // Sort Order 8
    {
        id: 'yWvKnLg2VRq',
        name: '12.Result of HIV test if you can tell?',
        formName: 'hivTestResult',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '១២.តើលទ្ធផលនៃការធ្វើតេស្តដូចម្តេចដែរ?' }]
    },
    // Sort Order 9
    {
        id: 'MBizmGFOeZg',
        name: 'Risk screening result',
        formName: 'riskScreeningResult',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: 'លទ្ធផលវាយតម្លៃកម្រិតប្រឈម' }]
    },
    // Sort Order 10
    {
        id: 'bls0dsZMoRO',
        name: '6.3 Sex with known HIV+ partner(s)',
        formName: 'sexWithHIVPartner',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៣ រួមភេទជាមួយអ្នកផ្ទុកមេរោគអេដស៍' }]
    },
    // Sort Order 11
    {
        id: 'JhZONUgUE87',
        name: '6.4 Sex without a condom',
        formName: 'sexWithoutCondom',
        valueType: 'BOOLEAN',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៤ រួមភេទដោយមិនប្រើស្រោមអនាម័យ' }]
    },
    // Sort Order 12
    {
        id: 'HnK9Yh1aWn1',
        name: '6.5 Have a STI symptom',
        formName: 'stiSymptoms',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៥ ធ្លាប់/កំពុងមានជំងឺកាមរោគ' }]
    },
    // Sort Order 13
    {
        id: 'y2jfGnMOTNH',
        name: '4.4 Tested syphilis positive',
        formName: 'syphilisPositive',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៤.៤ មេរោគស្វាយមានប្រត្តិកម្ម' }]
    },
    // Sort Order 14
    {
        id: 'b5Jgn263AJT',
        name: '6.1 Receive money or goods for sex',
        formName: 'receiveMoneyForSex',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.១ ធ្លាប់ទទួលថវិកាឬសម្ភារះជាថ្នូរនឹងការរួមភេទ' }]
    },
    // Sort Order 15
    {
        id: 'BKILZQUFa2t',
        name: '6.2 Paid for sex',
        formName: 'paidForSex',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.២ ធ្លាប់ទិញសេវាផ្លូវភេទ' }]
    },
    // Sort Order 16
    {
        id: 'Mm3MCV89ukA',
        name: '6.9 Injected drug/shared needle',
        formName: 'injectedDrugSharedNeedle',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៩ ធ្លាប់ចាក់គ្រឿងញៀនឬប្រើម្ជុលស៊ឺរាំងរួមគ្នា' }]
    },
    // Sort Order 17
    {
        id: 'fVWjzCcSCyF',
        name: '6.7 Alcohol/drug before sex',
        formName: 'alcoholDrugBeforeSex',
        valueType: 'BOOLEAN',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៧ ធ្លាប់ប្រើគ្រឿងស្រវឹងឬសារធាតុញៀន' }]
    },
    // Sort Order 18
    {
        id: 'FdYD7ISx2s6',
        name: '6.8 Joint high fun or group sex or chemsex',
        formName: 'groupSexChemsex',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៨ ធ្លាប់រួមភេទជាក្រុមហើយប្រើសារធាតុញៀន' }]
    },
    // Sort Order 19
    {
        id: 'LTf9Uj5JnqN',
        name: '9. Currently on PrEP',
        formName: 'currentlyOnPrep',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៩. កំពុងប្រើប្រាស់ប្រីព' }]
    },
    // Sort Order 20
    {
        id: 'ARFp7wrxiFV',
        name: '11. When did your last HIV test?',
        formName: 'lastHivTestDate',
        valueType: 'DATE',
        translations: [{ property: 'NAME', locale: 'km', value: '១១. តើធ្លាប់បានតេស្តមេរោគអេដស៍ដែរឬទេ?' }]
    },
    // Sort Order 21
    {
        id: 'Lbi259Segyq',
        name: '1. What is your sex at birth?',
        formName: 'sexAtBirth',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '១. តើភេទពីកំណើតជាអ្វី?' }]
    },
    // Sort Order 22
    {
        id: 'Hvpk8CSzvWZ',
        name: '2. How do you identify your gender?',
        formName: 'genderIdentity',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '២.តើអ្នកកំណត់អត្តសញ្ញាណភេទជាអ្វី?' }]
    },
    // Sort Order 23
    {
        id: 'nXk4YihKCF5',
        name: '6.6 Abortion',
        formName: 'abortion',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦.៦ ធ្លាប់រំលូតកូន' }]
    },
    // Sort Order 24
    {
        id: 'sEspagSJHg6',
        name: '7. Have you ever forced to have sex against your wishes in past 6 months',
        formName: 'forcedSex',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៧.ធ្លាប់មានការបង្ខំឱ្យរួមភេទដែរឬទេ?' }]
    },
    // Sort Order 25
    {
        id: 'HZzeCzQOuvh',
        name: '3. Have you ever concerns/worries about your sexual health?',
        formName: 'sexualHealthConcerns',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៣. តើធ្លាប់មានការព្រួយបារម្ភអំពីសុខភាពផ្លូវភេទដែរឬទេ?' }]
    },
    // Sort Order 26
    {
        id: 'eEY6HLGq5FF',
        name: 'Risk screening score',
        formName: 'riskScreeningScore',
        valueType: 'NUMBER',
        translations: []
    },
    // Sort Order 27
    {
        id: 'q4Xuew3y1c7',
        name: '6.10 Non-Above',
        formName: 'noneOfAbove',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '៦ ១០ មិនមែនទាំងអស់' }]
    },
    // Sort Order 28
    {
        id: 'ziEaDW60taC',
        name: '10.Have you ever on PrEP',
        formName: 'everOnPrep',
        valueType: 'TEXT',
        translations: [{ property: 'NAME', locale: 'km', value: '១០.តើអ្នកធ្លាប់ប្រើប្រាស់ប្រីពដែរឬទេ?' }]
    }
]

// Function to fetch and update program stage data from DHIS2
export const fetchAndUpdateProgramStageData = async (engine, programStageId = 'hqJKFmOU6s7') => {
    try {
        console.log('Fetching program stage data from DHIS2...')
        
        const response = await engine.query({
            programStage: {
                resource: 'programStages',
                id: programStageId,
                params: {
                    fields: 'id,name,programStageDataElements[dataElement[id,name,shortName,valueType,code,formName]]'
                }
            }
        })
        
        const stageData = response.programStage
        console.log('Program stage data fetched:', stageData)
        
        if (stageData?.programStageDataElements) {
            // Convert to our format
            const updatedElements = stageData.programStageDataElements.map(psde => ({
                dataElement: {
                    name: psde.dataElement.name,
                    id: psde.dataElement.id,
                    valueType: psde.dataElement.valueType,
                    shortName: psde.dataElement.shortName,
                    code: psde.dataElement.code,
                    formName: psde.dataElement.formName
                }
            }))
            
            // Update the static array
            programStageDataElements = updatedElements
            
            console.log(`Updated program stage data with ${updatedElements.length} elements:`, updatedElements)
            return updatedElements
        }
        
        return []
    } catch (error) {
        console.error('Error fetching program stage data:', error)
        return []
    }
}

// Function to get the current count of data elements
export const getDataElementCount = () => {
    return programStageDataElements.length
}

// Function to refresh data elements from DHIS2
export const refreshProgramStageData = async (engine) => {
    const updatedElements = await fetchAndUpdateProgramStageData(engine)
    return updatedElements
}

// Utility functions for working with program stage data

/**
 * Get all data element IDs from the program stage
 */
export const getDataElementIds = () => {
    return programStageDataElements.map(item => item.dataElement.id)
}

/**
 * Get data element by ID
 */
export const getDataElementById = (id) => {
    return programStageDataElements.find(item => item.dataElement.id === id)
}

/**
 * Get data elements by value type
 */
export const getDataElementsByValueType = (valueType) => {
    return programStageDataElements.filter(item => item.dataElement.valueType === valueType)
}

/**
 * Get data element names mapped to IDs
 */
export const getDataElementNameMap = () => {
    const nameMap = {}
    programStageDataElements.forEach(item => {
        nameMap[item.dataElement.id] = item.dataElement.name
    })
    return nameMap
}

/**
 * Validate data value based on data element value type
 */
export const validateDataValue = (dataElementId, value) => {
    const dataElement = getDataElementById(dataElementId)
    if (!dataElement) {
        return { isValid: false, error: 'Data element not found' }
    }

    const { valueType } = dataElement.dataElement

    switch (valueType) {
        case 'TEXT':
            return { isValid: true, value: String(value) }
        
        case 'BOOLEAN':
            if (typeof value === 'boolean') {
                return { isValid: true, value }
            }
            if (typeof value === 'string') {
                const lowerValue = value.toLowerCase()
                if (['true', 'yes', '1', 'on'].includes(lowerValue)) {
                    return { isValid: true, value: true }
                }
                if (['false', 'no', '0', 'off'].includes(lowerValue)) {
                    return { isValid: true, value: false }
                }
            }
            return { isValid: false, error: 'Invalid boolean value' }
        
        case 'TRUE_ONLY':
            if (value === true || value === 'true' || value === 'yes' || value === '1') {
                return { isValid: true, value: true }
            }
            return { isValid: true, value: false }
        
        default:
            return { isValid: true, value }
    }
}

/**
 * Convert CSV row to DHIS2 data values format
 */
export const csvRowToDataValues = (csvRow) => {
    const dataValues = []
    const nameMap = getDataElementNameMap()

    Object.keys(csvRow).forEach(key => {
        const dataElement = programStageDataElements.find(item => 
            item.dataElement.name === key || item.dataElement.id === key
        )
        
        if (dataElement) {
            const validation = validateDataValue(dataElement.dataElement.id, csvRow[key])
            if (validation.isValid) {
                dataValues.push({
                    dataElement: dataElement.dataElement.id,
                    value: validation.value
                })
            }
        }
    })

    return dataValues
}

/**
 * Generate sample data for testing
 */
export const generateSampleData = () => {
    const sampleData = []
    const currentDate = new Date()
    const month = String(currentDate.getMonth() + 1).padStart(2, '0')
    const year = currentDate.getFullYear()
    
    for (let i = 1; i <= 10; i++) {
        const record = {
            // Metadata columns
            System_ID: `STI_${String(i).padStart(4, '0')}`,
            No: i,
            Month: month,
            Year: year,
            Donor: 'Sample Donor',
            NGO: 'Sample NGO',
            Province: 'Sample Province',
            OD: 'Sample OD',
            District: 'Sample District',
            Commune: 'Sample Commune',
            Date: `${year}-${month}-01`,
            UUIC: `UUIC_${String(i).padStart(4, '0')}`,
            Fname: `First_${i}`,
            Lname: `Last_${i}`,
            DOB: `${1980 + Math.floor(Math.random() * 40)}-01-01`
        }

        // Add program stage data elements
        programStageDataElements.forEach(item => {
            const { id, valueType, name } = item.dataElement
            
            switch (valueType) {
                case 'TEXT':
                    if (name.includes('partner')) {
                        record[name] = Math.floor(Math.random() * 5) + 1
                    } else if (name.includes('test')) {
                        record[name] = Math.random() > 0.5 ? 'Yes' : 'No'
                    } else if (name.includes('result')) {
                        record[name] = Math.random() > 0.5 ? 'Positive' : 'Negative'
                    } else if (name.includes('score')) {
                        record[name] = Math.floor(Math.random() * 10) + 1
                    } else {
                        record[name] = Math.random() > 0.5 ? 'Yes' : 'No'
                    }
                    break
                
                case 'BOOLEAN':
                case 'TRUE_ONLY':
                    record[name] = Math.random() > 0.5
                    break
                
                default:
                    record[name] = Math.random() > 0.5 ? 'Yes' : 'No'
            }
        })

        sampleData.push(record)
    }

    return sampleData
}

/**
 * Get metadata column definitions
 */
export const getMetadataColumns = () => {
    return [
        { key: 'System_ID', label: 'System ID', type: 'text', required: true },
        { key: 'No', label: 'No', type: 'number', required: true },
        { key: 'Month', label: 'Month', type: 'text', required: true },
        { key: 'Year', label: 'Year', type: 'number', required: true },
        { key: 'Donor', label: 'Donor', type: 'text', required: false },
        { key: 'NGO', label: 'NGO', type: 'text', required: false },
        { key: 'Province', label: 'Province', type: 'text', required: true },
        { key: 'OD', label: 'OD', type: 'text', required: false },
        { key: 'District', label: 'District', type: 'text', required: false },
        { key: 'Commune', label: 'Commune', type: 'text', required: false },
        { key: 'Date', label: 'Date', type: 'date', required: true },
        { key: 'UUIC', label: 'UUIC', type: 'text', required: true },
        { key: 'Fname', label: 'First Name', type: 'text', required: true },
        { key: 'Lname', label: 'Last Name', type: 'text', required: true }
    ]
}

/**
 * Validate metadata record
 */
export const validateMetadataRecord = (record) => {
    const metadataColumns = getMetadataColumns()
    const errors = []
    
    metadataColumns.forEach(column => {
        if (column.required && (!record[column.key] || record[column.key] === '')) {
            errors.push(`${column.label} is required`)
        }
        
        if (record[column.key]) {
            switch (column.type) {
                case 'number':
                    if (isNaN(Number(record[column.key]))) {
                        errors.push(`${column.label} must be a number`)
                    }
                    break
                case 'date':
                    if (!Date.parse(record[column.key])) {
                        errors.push(`${column.label} must be a valid date`)
                    }
                    break
            }
        }
    })
    
    return {
        isValid: errors.length === 0,
        errors
    }
}

/**
 * Get complete Excel structure (metadata + program stage data)
 */
export const getExcelStructure = () => {
    const metadataColumns = getMetadataColumns()
    const dataElementColumns = programStageDataElements.map(item => ({
        key: item.dataElement.name,
        label: item.dataElement.name,
        type: item.dataElement.valueType.toLowerCase(),
        required: false,
        dataElementId: item.dataElement.id
    }))
    
    return [...metadataColumns, ...dataElementColumns]
}

/**
 * Convert Excel row to DHIS2 format with metadata
 */
export const excelRowToDHIS2Format = (row, programId, programStageId, orgUnitId) => {
    // Extract metadata
    const metadata = {
        systemId: row.System_ID,
        uuic: row.UUIC,
        firstName: row.Fname,
        lastName: row.Lname,
        date: row.Date,
        province: row.Province,
        district: row.District,
        commune: row.Commune,
        donor: row.Donor,
        ngo: row.NGO
    }
    
    // Extract data values
    const dataValues = csvRowToDataValues(row)
    
    return {
        trackedEntityInstance: row.System_ID,
        program: programId,
        programStage: programStageId,
        orgUnit: orgUnitId,
        eventDate: row.Date,
        dataValues,
        metadata
    }
}

/**
 * Export data to DHIS2 format
 */
export const exportToDHIS2Format = (data) => {
    return data.map(record => {
        const dataValues = csvRowToDataValues(record)
        return {
            trackedEntityInstance: record.System_ID,
            program: 'STI_PROGRAM', // Replace with actual program ID
            programStage: 'STI_PROGRAM_STAGE', // Replace with actual program stage ID
            orgUnit: record.Province, // Replace with actual org unit ID
            eventDate: record.Date,
            dataValues
        }
    })
}

/**
 * Get risk assessment score based on responses
 */
export const calculateRiskScore = (responses) => {
    let score = 0
    const riskFactors = [
        'bls0dsZMoRO', // Sex with known HIV+ partner(s)
        'JhZONUgUE87', // Sex without a condom
        'HnK9Yh1aWn1', // Have a STI symptom
        'y2jfGnMOTNH', // Tested syphilis positive
        'b5Jgn263AJT', // Receive money or goods for sex
        'BKILZQUFa2t', // Paid for sex
        'Mm3MCV89ukA', // Injected drug/shared needle
        'fVWjzCcSCyF', // Alcohol/drug before sex
        'FdYD7ISx2s6', // Joint high fun or group sex or chemsex
        'sEspagSJHg6'  // Forced to have sex
    ]

    riskFactors.forEach(factorId => {
        if (responses[factorId] === true || responses[factorId] === 'true' || responses[factorId] === 'yes') {
            score += 1
        }
    })

    return {
        score,
        riskLevel: score >= 3 ? 'High Risk' : score >= 1 ? 'Medium Risk' : 'Low Risk'
    }
}
